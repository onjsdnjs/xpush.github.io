/*! xpush javascript library - v0.1.0 - 2014-09-22
* https://xpush.github.io
* Copyright (c) 2014 John Kim; Licensed MIT */
!function(){var a=function(){"undefined"!=typeof module&&(http=require("http"),io=require("socket.io-client"));var a="session",b="channel",c={A:"app",C:"channel",U:"userId",US:"users",D:"deviceId",N:"notiId",S:"server",MG:"message",NM:"name",PW:"password",GR:"groups",DT:"datas",MD:"mode",TS:"timestamp",SS:"socketId",CD:"createDate",UD:"updateDate"},d={transports:["websocket"],"force new connection":!0},e="message",f=!1,g=function(){f&&("undefined"===console.log.bind?Function.prototype.bind.call(console.log,console,context):console.log.apply(console,arguments))},h=function(a,b,c,d){if(!a)return void alert("params(1) must have hostname");if(!b)return void alert("params(2) must have appId");var e=this;return e.appId=b,e._channels={},e.headers={},e._sessionConnection,e.maxConnection=5,e.maxTimeout=3e4,e.channelNameList=[],e.hostname=a,e.receiveMessageStack=[],e.isExistUnread=!0,e.autoInitFlag=!0,void 0!=d&&(e.autoInitFlag=d),e.on("newChannel",function(a){e.channelNameList.push(a.chNm)}),c&&(e._isEventHandler=!0,e.on("___session_event",c)),e};h.Context={SIGNUP:"/user/register",LOGIN:"/auth",Channel:"/channel",Signout:"/signout",Message:"/msg",NODE:"/node"},h.prototype.signup=function(a,b,c,d){var e=this;"function"!=typeof c||d||(d=c,c="WEB");var f={A:e.appId,U:a,PW:b,D:c};e.ajax(h.Context.SIGNUP,"POST",f,d)},h.prototype.login=function(b,c,d,e,f){var i=this;"function"!=typeof d||e||f||(f=d,d="WEB"),"function"!=typeof e||f||(f=e),i.userId=b,i.deviceId=d;var j={A:i.appId,U:b,PW:c,D:d};e&&(j.MD=e),i.ajax(h.Context.LOGIN,"POST",j,function(b,c){if(b)return void(f&&f(b,c));if("ok"==c.status){var d=i._sessionConnection=new k(i,a,c.result);d.connect(function(){g("xpush : login end",i.userId),i._initSessionSocket(i._sessionConnection._socket,function(){f&&f(c.message,c.result)})})}else f&&f(c.message),alert("xpush : login error"+c.message)})},h.prototype.setSessionInfo=function(a,b,c){var d=this;"function"!=typeof b||c||(c=b,b="WEB"),d.userId=a,d.deviceId=b,c()},h.prototype.logout=function(){var a=this;if(void 0!=a&&(void 0!=a._sessionConnection&&a._sessionConnection.disconnect(),void 0!=a._channels))for(var b in a._channels)a._channels[b]._connected&&a._channels[b].disconnect()},h.prototype.createChannel=function(a,b,c,d){var e=this,f=e._channels;3===arguments.length?"string"==typeof arguments[1]&&"function"==typeof arguments[2]?(d=c,c={}):"object"==typeof arguments[1]&&"function"==typeof arguments[2]&&(d=c,c=b,b=void 0):"function"!=typeof b||c||d||(d=b,b=void 0,c={});var g,h=b;return a.indexOf(e.userId)<0&&a.push(e.userId),e.sEmit("channel-create",{C:b,U:a,DT:c},function(a,b){a&&"WARN-EXISTED"!=a&&d&&d(a,b),h=b.C||h,e._getChannelInfo(h,function(a,b){a?console.log(" == node channel ",a):"ok"==b.status&&(g.setServerInfo(b.result),f[h]=g,d&&d(null,h))})}),g=e._makeChannel(h)},h.prototype.createSimpleChannel=function(a,b,c){var d=this,e=d._makeChannel(a);d._getChannelInfo(a,function(a,f){a?(g(" == node channel ",a),c&&c(a)):"ok"==f.status&&("function"!=typeof b||c||(c=b,b=void 0),b?(d.userId=b.U||"someone",d.deviceId=b.D||"WEB"):(d.userId="someone",d.deviceId="WEB"),e.info=f.result,e._server={serverUrl:f.result.server.url},e.chNm=f.result.channel,e.connect(function(){c&&c()},"CHANNEL_ONLY"))})},h.prototype.getChannels=function(a){var b=this;g("xpush : getChannels ",b.userId),b.sEmit("channel-list",function(b,c){g("xpush : getChannels end ",c),["A","C","CD","US"].forEach(function(a){l.changeKey(c,a)}),c.length>0&&c.forEach(function(a){["D","N","U"].forEach(function(b){l.changeKey(a.users,b)})}),a(b,c)})},h.prototype.updateChannel=function(a,b,c){var d=this,e={A:d.appId,C:a,Q:b};d.sEmit("channel-update",e,function(a,b){g("xpush : channel-update end ",b),c(a,b)})},h.prototype.getChannelsActive=function(a,b){var c=this;c.sEmit("channel-list-active",a,function(a,c){b(c)})},h.prototype.getChannel=function(a){var b=this,c=b._channels;for(var d in c)if(d==a)return c[d];return void 0},h.prototype.getChannelData=function(a,b){var c=this;c.sEmit("channel-get",{C:a,U:{}},function(a,c){b&&b(a,c)})},h.prototype.joinChannel=function(a,b,c){var d=this;d._getChannelAsync(a,function(a,d){d.joinChannel(b,function(a){c(a)})})},h.prototype.exitChannel=function(a,b){var c=this;c.sEmit("channel-exit",{C:a},function(a,c){b&&b(a,c)})},h.prototype._getChannelAsync=function(a,b){var c=this,d=c.getChannel(a);d?b(!1,d):(c._channels[a]=d,d=c._makeChannel(a),c._getChannelInfo(a,function(a,c){a?(g(" == node channel ",a),b(a)):"ok"==c.status&&d.setServerInfo(c.result,function(){b(!1,d)})}))},h.prototype.uploadStream=function(a,b,c,d){var e=this;e._getChannelAsync(a,function(a,e){for(var f=[],g=[],h=0;h<b.file.files.length;h++){var i=b.file.files[h],j=128;i.size>1048576?j=256:i.size>4194304&&(j=512);var k=0;g[h]=ss.createStream({highWaterMark:1024*j}),f[h]=ss.createBlobReadStream(i,{highWaterMark:1024*j}),f[h].on("data",function(a){k+=a.length,c(Math.floor(k/i.size*100),h)});var l={};l.orgName=i.name,b.overwrite&&(l.name=i.name),b.type&&(l.type=b.type),e.upload(g[h],l,function(a){d(a,h)}),f[h].pipe(g[h])}})},h.prototype.uploadFile=function(a,b,c,d,e){var f=this;f._getChannelAsync(a,function(h,i){if(window.FileTransfer&&window.FileUploadOptions){var j=i._server.serverUrl+"/upload",k=new FileUploadOptions;k.fileKey="post",k.chunkedMode=!1,k.params={key1:"VAL1",key2:"VAL2"},k.headers={"XP-A":f.appId,"XP-C":a,"XP-U":JSON.stringify({U:f.userId,D:f.deviceId})},k.headers["XP-FU-org"]=c.name,c.overwrite&&(k.headers["XP-FU-nm"]=c.name),c.type&&(k.headers["XP-FU-tp"]=c.type);var l=new FileTransfer;void 0!=d&&(l.onprogress=function(a){if(a.lengthComputable){var b=Math.floor(a.loaded/a.total*100);d(b)}}),l.upload(b,encodeURI(j),function(a){e(a)},function(a){g("On fail "+a)},k)}})},h.prototype.getFileUrl=function(a,b){var c=this,d=c.getChannel(a),e=d.info.server.url+"/download/"+d._xpush.appId+"/"+d.info.channel+"/"+d._xpush.userId+"/"+d._socket.io.engine.id+"/"+b;return e},h.prototype._makeChannel=function(a){var c=this;g("xpush : connection _makeChannel ",a);for(var d in c._channels)if(d==a&&void 0!=c._channels[d]&&c._channels[d]._connected)return c._channels[d];var e=new k(c,b);return a&&(e.channel=a,c._channels[a]=e),e},h.prototype.calcChannel=function(){var a=this;a._channels.length>=a.maxConnection&&a._deleteChannel(a._channels[a._channels.length-1])},h.prototype._deleteChannel=function(a){var b=this;for(var c in b._channels)if(b._channels[c]==a){b._channels[c].disconnect(),delete b._channels[c];break}},h.prototype.isExistChannel=function(a){for(var b=this,c=0;c<b.channelNameList.length;c++)if(b.channelNameList[c]==a)return!0;return!1},h.prototype.getUserList=function(a,b){"function"==typeof a&&(b=a,a={}),a=void 0==a?{}:a;var c=this;g("xpush : getUsertList ",a),c.sEmit("user-list",a,function(a,c){b&&b(a,c.users,c.count)})},h.prototype.queryUser=function(a,b){var c=this;a.query||console.error("Query User","query is not existed."),a.column||console.error("Query User","column is not existed.");var d={query:a.query,column:a.column};a.options&&(d.options=a.options),g("xpush : queryUser ",d),c.sEmit("user-query",d,function(a,c){b&&b(a,c.users,c.count)})},h.prototype.send=function(a,b,c){var d=this;d._getChannelAsync(a,function(a,d){d.send(b,c)})},h.prototype.getUnreadMessage=function(a){var b=this;g("xpush : getUnreadMessage ",b.userId),b.sEmit("message-unread",function(c,d){g("xpush : getUnreadMessage end ",d),d&&d.length>0&&d.sort(l.messageTimeSort),b.isExistUnread=!1,b.sEmit("message-received"),a(c,d)})},h.prototype._getChannelInfo=function(a,b){var c=this;g("xpush : _getChannelInfo ",a),c.ajax(h.Context.NODE+"/"+c.appId+"/"+a,"GET",{},b)},h.prototype.getGroupUsers=function(a,b){var c=this;"function"==typeof arguments[0]&&(b=arguments[0],a=void 0),a=a?a:c.userId,c.sEmit("group-list",{GR:a},function(a,c){b(a,c)})},h.prototype.addUserToGroup=function(a,b,c){var d=this;"function"==typeof arguments[1]&&(c=arguments[1],b=a,a=void 0),a=a?a:d.userId,b=b?b:[],d.sEmit("group-add",{GR:a,U:b},function(a,b){c(a,b)})},h.prototype.removeUserFromGroup=function(a,b,c){var d=this;"function"==typeof arguments[1]&&(c=arguments[1],b=a,a=void 0),a=a?a:d.userId,d.sEmit("group-remove",{GR:a,U:b},function(a,b){c(a,b)})},h.prototype._initSessionSocket=function(a,c){var d=this;a.on("_event",function(a){switch(g("xpush : session receive ",a.event,a.C,a.NM,a.DT,d.userId),a.event){case"NOTIFICATION":var b=d.getChannel(a.C);d.autoInitFlag&&(b||(b=d._makeChannel(a.C),d._getChannelInfo(a.C,function(a,c){a?g(" == node channel ",a):"ok"==c.status&&b.setServerInfo(c.result)}),d.isExistChannel(a.channel)||d.emit("newChannel",b)),b.emit(a.NM,a.DT)),d.emit(a.NM,a.C,a.NM,a.DT);break;case"CONNECT":d.emit("___session_event","SESSION",a);break;case"DISCONNECT":d.emit("___session_event","SESSION",a);break;case"LOGOUT":d.emit("___session_event","LOGOUT",a)}}),a.on("channel",function(a){switch(g("xpush : session receive ","channel",a,d.userId),a.event){case"UPDATE":break;case"REMOVE":}}),a.on("connected",function(){g("xpush : session receive ",b,arguments,d.userId)}),d.autoInitFlag?d.getChannels(function(a,b){d.channelNameList=b,d.getUnreadMessage(function(a,b){if(b&&b.length>0){for(var f=b.length-1;f>=0;f--)b[f].MG.DT=JSON.parse(b[f].MG.DT),d.receiveMessageStack.unshift([e,b[f].MG.DT.C,b[f].NM,b[f].MG.DT]);for(d.isExistUnread=!1;d.receiveMessageStack.length>0;){var g=d.receiveMessageStack.shift();d.emit.apply(d,g)}c&&c()}else c&&c()})}):c&&c(),a.on("disconnect",function(){d.isExistUnread=!0})};var i=function(a,b,c,d,e){var f=this;"function"!=typeof d||e||(e=d,d=void 0);var h=f.hostname.replace("http://","");h.indexOf(":")>0&&(h=h.split(":")[0]);var i={host:h,port:8e3,path:a,method:b};i.headers=d?d:{},i.headers["Content-Type"]="application/json";var j="",k=http.request(i,function(a){a.setEncoding("utf8"),a.on("data",function(a){j+=a}),a.on("end",function(){var a=JSON.parse(j);"ok"!=a.status?e(a.status,a.mesage):e(null,a)})}).on("error",function(a){g("ajax error: "+a.message),e("",j)});b.toLowerCase()!=="GET".toLowerCase()&&k.write(JSON.stringify(c)),k.end()},j=function(a,b,c,d,e){var f=this;"function"!=typeof d||e||(e=d,d=!1);var h;try{h=new XMLHttpRequest}catch(i){try{h=new XDomainRequest}catch(i){try{h=new ActiveXObject("Msxml2.XMLHTTP")}catch(i){try{h=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){console.error("\nYour browser is not compatible with XPUSH AJAX")}}}}var j=f.hostname+a,k=Object.keys(c).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(c[a])}).join("&");if(b="get"==b.toLowerCase()?"GET":"POST",k=null==k||""==k?null:k,"GET"==b&&null!=k&&(j=j+"?"+k),h.open(b,j,!0),h.onreadystatechange=function(){if(!(h.readyState<4)&&(200!==h.status&&(g("xpush : ajax error",f.hostname+a,k),e(h.status,{})),4===h.readyState)){var b=JSON.parse(h.responseText);"ok"!=b.status?e(b.status,b.mesage):e(null,b)}},g("xpush : ajax ",f.hostname+a,b,k),d)for(var l in d)d.hasOwnProperty(l)&&h.setRequestHeader(l,d[l]);h.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h.send("POST"==b?k:null)};h.prototype.ajax="undefined"!=typeof module&&"undefined"!=typeof module.exports?i:j,h.prototype.sEmit=function(a,b,c){var d=this,e=function(b){"ok"==b.status?c(null,b.result):(0==b.status.indexOf("WARN")?console.warn("xpush : ",a,b.status,b.message):console.error("xpush : ",a,b.status,b.message),c(b.status,b.message))};"function"==typeof arguments[1]?(c=b,d._sessionConnection._socket.emit(a,e)):d._sessionConnection._socket.emit(a,b,e)},h.prototype.on=function(a,b){var c=this;c._events=c._events||{},c._events[a]=c._events[a]||[],c._events[a].push(b)},h.prototype.off=function(a,b){var c=this;c._events=c._events||{},a in c._events!=!1&&c._events[a].splice(c._events[a].indexOf(b),1)},h.prototype.clearEvent=function(){var a=this;a._events={}},h.prototype.emit=function(a){var b=this;if(b.isExistUnread)b.receiveMessageStack.push(arguments);else{if(b._events=b._events||{},a in b._events==!1)return;for(var c=0;c<b._events[a].length;c++)g("xpush : test ",arguments),b._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))}};var k=function(b,c,d){return this._xpush=b,this._server=d,this._type=c,this._type==a&&(this.chNm=a),this._socketStatus,this._socket,this.checkTimer,this.info,this.messageStack=[],this.isFirtConnect=!0,this._connected=!1,this.timeout=3e4,this};k.prototype.checkConnectionTimeout=function(a){var b=this;b.checkTimer&&clearTimeout(b.checkTimer),a&&(b.checkTimer=setTimeout(function(){b._socket.disconnect()},b.timeout))},k.prototype.setServerInfo=function(a,b){g("xpush : setServerInfo ",a);var c=this;c.info=a,c._server={serverUrl:a.server.url},c.chNm=a.channel,c.connect(function(){g("xpush : setServerInfo end ",arguments,c._xpush.userId,c.chNm),b&&b()})},k.prototype.connect=function(a,c){var e=this,f="A="+e._xpush.appId+"&U="+e._xpush.userId+"&D="+e._xpush.deviceId+"&TK="+e._server.token;e._type==b&&(f="A="+e._xpush.appId+"&C="+e.chNm+"&U="+e._xpush.userId+"&D="+e._xpush.deviceId+"&S="+e.info.server.name,c&&("CHANNEL_ONLY"==c&&(e._xpush.isExistUnread=!1),f=f+"&MD="+c)),e._socket=io.connect(e._server.serverUrl+"/"+e._type+"?"+f,d),g("xpush : socketconnect",e._server.serverUrl+"/"+e._type+"?"+f),e._socket.on("connect",function(){for(g("channel connection completed");e.messageStack.length>0;){var b=e.messageStack.shift();e._socket.emit("send",{NM:b.NM,DT:b.DT})}e._connected=!0,e.isFirtConnect&&(e.isFirtConnect=!1,e.connectionCallback(a))}),e._socket.on("disconnect",function(){e._connected=!1})},k.prototype.connectionCallback=function(a){var b=this;g("xpush : connection ","connectionCallback",b._type,b._xpush.userId,b.chNm),b._socket.on("message",function(a){g("xpush : channel receive ",b.chNm,a,b._xpush.userId),b._xpush.emit(e,b.chNm,e,a)}),b._socket.on("system",function(a){g("xpush : channel receive system",b.chNm,a,b._xpush.userId),b._xpush.emit("system",b.chNm,"system",a)}),b._xpush._isEventHandler&&b._socket.on("_event",function(a){switch(a.event){case"CONNECTION":b._xpush.emit("___session_event","CHANNEL",a);break;case"DISCONNECT":b._xpush.emit("___session_event","CHANNEL",a)}}),a&&a()},k.prototype.disconnect=function(){g("xpush : socketdisconnect ",this.chNm,this._xpush.userId),this._socket.disconnect()},k.prototype.send=function(a,b){var c=this;c._connected?c._socket.emit("send",{NM:a,DT:b}):c.messageStack.push({NM:a,DT:b})},k.prototype.joinChannel=function(a,b){var c=this;c._socket.connected&&c._socket.emit("join",a,function(a){b(a)})},k.prototype.upload=function(a,b,c){var d=this;d._socket.connected&&ss(d._socket).emit("file-upload",a,b,c)},k.prototype.on=function(a,b){var c=this;c._events=c._events||{},c._events[a]=c._events[a]||[],c._events[a].push(b)},k.prototype.off=function(a,b){var c=this;c._events=c._events||{},a in c._events!=!1&&c._events[a].splice(c._events[a].indexOf(b),1)},k.prototype.emit=function(a){var b=this;if(b._events=b._events||{},a in b._events!=!1)for(var c=0;c<b._events[a].length;c++)b._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))};var l={};return l.messageTimeSort=function(a,b){return a.created>b.created},l.changeKey=function(a,b){a instanceof Array?a.forEach(function(a){a[c[b]]=a[b],delete a[b]}):(a[c[b]]=a[b],delete a[b])},h}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=a:"function"==typeof define&&define.amd?define([],function(){return a}):window.XPush=a}();