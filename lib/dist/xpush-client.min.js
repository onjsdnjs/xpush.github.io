/*! xpush javascript library - v0.1.0 - 2014-09-21
* https://xpush.github.io
* Copyright (c) 2014 John Kim; Licensed MIT */
!function(){var a=function(){var a,b;"undefined"!=typeof module&&(a=require("http"),b=require("socket.io-client"));var c="session",d="channel",e={A:"app",C:"channel",U:"userId",US:"users",D:"deviceId",N:"notiId",S:"server",MG:"message",NM:"name",PW:"password",GR:"groups",DT:"datas",MD:"mode",TS:"timestamp",SS:"socketId",CD:"createDate",UD:"updateDate"},f={transports:["websocket"],"force new connection":!0},g="message",h=function(a,b,c,d){if(!a)return void alert("params(1) must have hostname");if(!b)return void alert("params(2) must have appId");var e=this;return e.appId=b,e._channels={},e.headers={},e._sessionConnection,e.maxConnection=5,e.maxTimeout=3e4,e.channelNameList=[],e.hostname=a,e.receiveMessageStack=[],e.isExistUnread=!0,e.autoInitFlag=!0,void 0!=d&&(e.autoInitFlag=d),e.on("newChannel",function(a){e.channelNameList.push(a.chNm)}),c&&(e._isEventHandler=!0,e.on("___session_event",c)),e};h.Context={SIGNUP:"/user/register",LOGIN:"/auth",Channel:"/channel",Signout:"/signout",Message:"/msg",NODE:"/node"},h.prototype.signup=function(a,b,c,d){var e=this;"function"!=typeof c||d||(d=c,c="WEB");var f={A:e.appId,U:a,PW:b,D:c};e.ajax(h.Context.SIGNUP,"POST",f,d)},h.prototype.login=function(a,b,d,e,f){var g=this;"function"!=typeof d||e||f||(f=d,d="WEB"),"function"!=typeof e||f||(f=e),g.userId=a,g.deviceId=d;var i={A:g.appId,U:a,PW:b,D:d};e&&(i.MD=e),g.ajax(h.Context.LOGIN,"POST",i,function(a,b){if(a)return void(f&&f(a,b));if("ok"==b.status){var d=g._sessionConnection=new k(g,c,b.result);d.connect(function(){console.log("xpush : login end",g.userId),g._initSessionSocket(g._sessionConnection._socket,function(){f&&f(b.message,b.result)})})}else f&&f(b.message),alert("xpush : login error"+b.message)})},h.prototype.setSessionInfo=function(a,b,c){var d=this;"function"!=typeof b||c||(c=b,b="WEB"),d.userId=a,d.deviceId=b,c()},h.prototype.logout=function(){var a=this;if(void 0!=a&&(void 0!=a._sessionConnection&&a._sessionConnection.disconnect(),void 0!=a._channels))for(var b in a._channels)a._channels[b]._connected&&a._channels[b].disconnect()},h.prototype.createChannel=function(a,b,c,d){var e=this,f=e._channels;3===arguments.length?"string"==typeof arguments[1]&&"function"==typeof arguments[2]?(d=c,c={}):"object"==typeof arguments[1]&&"function"==typeof arguments[2]&&(d=c,c=b,b=void 0):"function"!=typeof b||c||d||(d=b,b=void 0,c={});var g,h=b;return a.indexOf(e.userId)<0&&a.push(e.userId),e.sEmit("channel-create",{C:b,U:a,DT:c},function(a,b){a&&"WARN-EXISTED"!=a&&d&&d(a,b),h=b.C||h,e._getChannelInfo(h,function(a,b){a?console.log(" == node channel ",a):"ok"==b.status&&(g.setServerInfo(b.result),f[h]=g,d&&d(null,h))})}),g=e._makeChannel(h)},h.prototype.createSimpleChannel=function(a,b,c){var d=this,e=d._makeChannel(a);d._getChannelInfo(a,function(a,f){a?(console.log(" == node channel ",a),c&&c(a)):"ok"==f.status&&("function"!=typeof b||c||(c=b,b=void 0),b?(d.userId=b.U||"someone",d.deviceId=b.D||"WEB"):(d.userId="someone",d.deviceId="WEB"),e.info=f.result,e._server={serverUrl:f.result.server.url},e.chNm=f.result.channel,e.connect(function(){c&&c()},"CHANNEL_ONLY"))})},h.prototype.getChannels=function(a){var b=this;console.log("xpush : getChannels ",b.userId),b.sEmit("channel-list",function(b,c){console.log("xpush : getChannels end ",c),["A","C","CD","US"].forEach(function(a){l.changeKey(c,a)}),c.length>0&&c.forEach(function(a){["D","N","U"].forEach(function(b){l.changeKey(a.users,b)})}),a(b,c)})},h.prototype.updateChannel=function(a,b,c){var d=this,e={A:d.appId,C:a,Q:b};d.sEmit("channel-update",e,function(a,b){console.log("xpush : channel-update end ",b),c(a,b)})},h.prototype.getChannelsActive=function(a,b){var c=this;c.sEmit("channel-list-active",a,function(a,c){b(c)})},h.prototype.getChannel=function(a){var b=this,c=b._channels;for(var d in c)if(d==a)return c[d];return void 0},h.prototype.getChannelData=function(a,b){var c=this;c.sEmit("channel-get",{C:a,U:{}},function(a,c){b&&b(a,c)})},h.prototype.joinChannel=function(a,b,c){var d=this;d._getChannelAsync(a,function(a,d){d.joinChannel(b,function(a){c(a)})})},h.prototype.exitChannel=function(a,b){var c=this;c.sEmit("channel-exit",{C:a},function(a,c){b&&b(a,c)})},h.prototype._getChannelAsync=function(a,b){var c=this,d=c.getChannel(a);d?b(!1,d):(c._channels[a]=d,d=c._makeChannel(a),c._getChannelInfo(a,function(a,c){a?(console.log(" == node channel ",a),b(a)):"ok"==c.status&&d.setServerInfo(c.result,function(){b(!1,d)})}))},h.prototype.uploadStream=function(a,b,c,d){var e=this;e._getChannelAsync(a,function(a,e){for(var f=[],g=[],h=0;h<b.file.files.length;h++){var i=b.file.files[h],j=128;i.size>1048576?j=256:i.size>4194304&&(j=512);var k=0;g[h]=ss.createStream({highWaterMark:1024*j}),f[h]=ss.createBlobReadStream(i,{highWaterMark:1024*j}),f[h].on("data",function(a){k+=a.length,c(Math.floor(k/i.size*100),h)});var l={};l.orgName=i.name,b.overwrite&&(l.name=i.name),b.type&&(l.type=b.type),e.upload(g[h],l,function(a){d(a,h)}),f[h].pipe(g[h])}})},h.prototype.uploadFile=function(a,b,c,d,e){var f=this;f._getChannelAsync(a,function(g,h){if(window.FileTransfer&&window.FileUploadOptions){var i=h._server.serverUrl+"/upload",j=new FileUploadOptions;j.fileKey="post",j.chunkedMode=!1,j.params={key1:"VAL1",key2:"VAL2"},j.headers={"XP-A":f.appId,"XP-C":a,"XP-U":JSON.stringify({U:f.userId,D:f.deviceId})},j.headers["XP-FU-org"]=c.name,c.overwrite&&(j.headers["XP-FU-nm"]=c.name),c.type&&(j.headers["XP-FU-tp"]=c.type);var k=new FileTransfer;void 0!=d&&(k.onprogress=function(a){if(a.lengthComputable){var b=Math.floor(a.loaded/a.total*100);d(b)}}),k.upload(b,encodeURI(i),function(a){e(a)},function(a){console.log("On fail "+a)},j)}})},h.prototype.getFileUrl=function(a,b){var c=this,d=c.getChannel(a),e=d.info.server.url+"/download/"+d._xpush.appId+"/"+d.info.channel+"/"+d._xpush.userId+"/"+d._socket.io.engine.id+"/"+b;return e},h.prototype._makeChannel=function(a){var b=this;console.log("xpush : connection _makeChannel ",a);for(var c in b._channels)if(c==a&&void 0!=b._channels[c]&&b._channels[c]._connected)return b._channels[c];var e=new k(b,d);return a&&(e.channel=a,b._channels[a]=e),e},h.prototype.calcChannel=function(){var a=this;a._channels.length>=a.maxConnection&&a._deleteChannel(a._channels[a._channels.length-1])},h.prototype._deleteChannel=function(a){var b=this;for(var c in b._channels)if(b._channels[c]==a){b._channels[c].disconnect(),delete b._channels[c];break}},h.prototype.isExistChannel=function(a){for(var b=this,c=0;c<b.channelNameList.length;c++)if(b.channelNameList[c]==a)return!0;return!1},h.prototype.getUserList=function(a,b){"function"==typeof a&&(b=a,a={}),a=void 0==a?{}:a;var c=this;console.log("xpush : getUsertList ",a),c.sEmit("user-list",a,function(a,c){b&&b(a,c.users,c.count)})},h.prototype.queryUser=function(a,b){var c=this;a.query||console.error("Query User","query is not existed."),a.column||console.error("Query User","column is not existed.");var d={query:a.query,column:a.column};a.options&&(d.options=a.options),console.log("xpush : queryUser ",d),c.sEmit("user-query",d,function(a,c){b&&b(a,c.users,c.count)})},h.prototype.send=function(a,b,c){var d=this;d._getChannelAsync(a,function(a,d){d.send(b,c)})},h.prototype.getUnreadMessage=function(a){var b=this;console.log("xpush : getUnreadMessage ",b.userId),b.sEmit("message-unread",function(c,d){console.log("xpush : getUnreadMessage end ",d),d&&d.length>0&&d.sort(l.messageTimeSort),b.isExistUnread=!1,b.sEmit("message-received"),a(c,d)})},h.prototype._getChannelInfo=function(a,b){var c=this;console.log("xpush : _getChannelInfo ",a),c.ajax(h.Context.NODE+"/"+c.appId+"/"+a,"GET",{},b)},h.prototype.getGroupUsers=function(a,b){var c=this;"function"==typeof arguments[0]&&(b=arguments[0],a=void 0),a=a?a:c.userId,c.sEmit("group-list",{GR:a},function(a,c){b(a,c)})},h.prototype.addUserToGroup=function(a,b,c){var d=this;"function"==typeof arguments[1]&&(c=arguments[1],b=a,a=void 0),a=a?a:d.userId,b=b?b:[],d.sEmit("group-add",{GR:a,U:b},function(a,b){c(a,b)})},h.prototype.removeUserFromGroup=function(a,b,c){var d=this;"function"==typeof arguments[1]&&(c=arguments[1],b=a,a=void 0),a=a?a:d.userId,d.sEmit("group-remove",{GR:a,U:b},function(a,b){c(a,b)})},h.prototype._initSessionSocket=function(a,b){var c=this;a.on("_event",function(a){switch(console.log("xpush : session receive ",a.event,a.C,a.NM,a.DT,c.userId),a.event){case"NOTIFICATION":var b=c.getChannel(a.C);c.autoInitFlag&&(b||(b=c._makeChannel(a.C),c._getChannelInfo(a.C,function(a,c){a?console.log(" == node channel ",a):"ok"==c.status&&b.setServerInfo(c.result)}),c.isExistChannel(a.channel)||c.emit("newChannel",b)),b.emit(a.NM,a.DT)),c.emit(a.NM,a.C,a.NM,a.DT);break;case"CONNECT":c.emit("___session_event","SESSION",a);break;case"DISCONNECT":c.emit("___session_event","SESSION",a);break;case"LOGOUT":c.emit("___session_event","LOGOUT",a)}}),a.on("channel",function(a){switch(console.log("xpush : session receive ","channel",a,c.userId),a.event){case"UPDATE":break;case"REMOVE":}}),a.on("connected",function(){console.log("xpush : session receive ",d,arguments,c.userId)}),c.autoInitFlag?c.getChannels(function(a,d){c.channelNameList=d,c.getUnreadMessage(function(a,d){if(d&&d.length>0){for(var e=d.length-1;e>=0;e--)d[e].MG.DT=JSON.parse(d[e].MG.DT),c.receiveMessageStack.unshift([g,d[e].MG.DT.C,d[e].NM,d[e].MG.DT]);for(c.isExistUnread=!1;c.receiveMessageStack.length>0;){var f=c.receiveMessageStack.shift();c.emit.apply(c,f)}b&&b()}else b&&b()})}):b&&b(),a.on("disconnect",function(){c.isExistUnread=!0})};var i=function(b,c,d,e,f){var g=this;"function"!=typeof e||f||(f=e,e=void 0);var h=g.hostname.replace("http://","");h.indexOf(":")>0&&(h=h.split(":")[0]);var i={host:h,port:8e3,path:b,method:c};i.headers=e?e:{},i.headers["Content-Type"]="application/json";var j="",k=a.request(i,function(a){a.setEncoding("utf8"),a.on("data",function(a){j+=a}),a.on("end",function(){var a=JSON.parse(j);"ok"!=a.status?f(a.status,a.mesage):f(null,a)})}).on("error",function(a){console.log("ajax error: "+a.message),f("",j)});c.toLowerCase()!=="GET".toLowerCase()&&k.write(JSON.stringify(d)),k.end()},j=function(a,b,c,d,e){var f=this;"function"!=typeof d||e||(e=d,d=!1);var g;try{g=new XMLHttpRequest}catch(h){try{g=new XDomainRequest}catch(h){try{g=new ActiveXObject("Msxml2.XMLHTTP")}catch(h){try{g=new ActiveXObject("Microsoft.XMLHTTP")}catch(h){console.error("\nYour browser is not compatible with XPUSH AJAX")}}}}var i=f.hostname+a,j=Object.keys(c).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(c[a])}).join("&");if(b="get"==b.toLowerCase()?"GET":"POST",j=null==j||""==j?null:j,"GET"==b&&null!=j&&(i=i+"?"+j),g.open(b,i,!0),g.onreadystatechange=function(){if(!(g.readyState<4)&&(200!==g.status&&(console.log("xpush : ajax error",f.hostname+a,j),e(g.status,{})),4===g.readyState)){var b=JSON.parse(g.responseText);"ok"!=b.status?e(b.status,b.mesage):e(null,b)}},console.log("xpush : ajax ",f.hostname+a,b,j),d)for(var k in d)d.hasOwnProperty(k)&&g.setRequestHeader(k,d[k]);g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.send("POST"==b?j:null)};h.prototype.ajax="undefined"!=typeof module&&"undefined"!=typeof module.exports?i:j,h.prototype.sEmit=function(a,b,c){var d=this,e=function(b){"ok"==b.status?c(null,b.result):(0==b.status.indexOf("WARN")?console.warn("xpush : ",a,b.status,b.message):console.error("xpush : ",a,b.status,b.message),c(b.status,b.message))};"function"==typeof arguments[1]?(c=b,d._sessionConnection._socket.emit(a,e)):d._sessionConnection._socket.emit(a,b,e)},h.prototype.on=function(a,b){var c=this;c._events=c._events||{},c._events[a]=c._events[a]||[],c._events[a].push(b)},h.prototype.off=function(a,b){var c=this;c._events=c._events||{},a in c._events!=!1&&c._events[a].splice(c._events[a].indexOf(b),1)},h.prototype.clearEvent=function(){var a=this;a._events={}},h.prototype.emit=function(a){var b=this;if(b.isExistUnread)b.receiveMessageStack.push(arguments);else{if(b._events=b._events||{},a in b._events==!1)return;for(var c=0;c<b._events[a].length;c++)console.log("xpush : test ",arguments),b._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))}};var k=function(a,b,d){return this._xpush=a,this._server=d,this._type=b,this._type==c&&(this.chNm=c),this._socketStatus,this._socket,this.checkTimer,this.info,this.messageStack=[],this.isFirtConnect=!0,this._connected=!1,this.timeout=3e4,this};k.prototype.checkConnectionTimeout=function(a){var b=this;b.checkTimer&&clearTimeout(b.checkTimer),a&&(b.checkTimer=setTimeout(function(){b._socket.disconnect()},b.timeout))},k.prototype.setServerInfo=function(a,b){console.log("xpush : setServerInfo ",a);var c=this;c.info=a,c._server={serverUrl:a.server.url},c.chNm=a.channel,c.connect(function(){console.log("xpush : setServerInfo end ",arguments,c._xpush.userId,c.chNm),b&&b()})},k.prototype.connect=function(a,c){var e=this,g="A="+e._xpush.appId+"&U="+e._xpush.userId+"&D="+e._xpush.deviceId+"&TK="+e._server.token;e._type==d&&(g="A="+e._xpush.appId+"&C="+e.chNm+"&U="+e._xpush.userId+"&D="+e._xpush.deviceId+"&S="+e.info.server.name,c&&("CHANNEL_ONLY"==c&&(e._xpush.isExistUnread=!1),g=g+"&MD="+c)),e._socket=b.connect(e._server.serverUrl+"/"+e._type+"?"+g,f),console.log("xpush : socketconnect",e._server.serverUrl+"/"+e._type+"?"+g),e._socket.on("connect",function(){for(console.log("channel connection completed");e.messageStack.length>0;){var b=e.messageStack.shift();e._socket.emit("send",{NM:b.NM,DT:b.DT})}e._connected=!0,e.isFirtConnect&&(e.isFirtConnect=!1,e.connectionCallback(a))}),e._socket.on("disconnect",function(){e._connected=!1})},k.prototype.connectionCallback=function(a){var b=this;console.log("xpush : connection ","connectionCallback",b._type,b._xpush.userId,b.chNm),b._socket.on("message",function(a){console.log("xpush : channel receive ",b.chNm,a,b._xpush.userId),b._xpush.emit(g,b.chNm,g,a)}),b._socket.on("system",function(a){console.log("xpush : channel receive system",b.chNm,a,b._xpush.userId),b._xpush.emit("system",b.chNm,"system",a)}),b._xpush._isEventHandler&&b._socket.on("_event",function(a){switch(a.event){case"CONNECTION":b._xpush.emit("___session_event","CHANNEL",a);break;case"DISCONNECT":b._xpush.emit("___session_event","CHANNEL",a)}}),a&&a()},k.prototype.disconnect=function(){console.log("xpush : socketdisconnect ",this.chNm,this._xpush.userId),this._socket.disconnect()},k.prototype.send=function(a,b){var c=this;c._connected?c._socket.emit("send",{NM:a,DT:b}):c.messageStack.push({NM:a,DT:b})},k.prototype.joinChannel=function(a,b){var c=this;c._socket.connected&&c._socket.emit("join",a,function(a){b(a)})},k.prototype.upload=function(a,b,c){var d=this;d._socket.connected&&ss(d._socket).emit("file-upload",a,b,c)},k.prototype.on=function(a,b){var c=this;c._events=c._events||{},c._events[a]=c._events[a]||[],c._events[a].push(b)},k.prototype.off=function(a,b){var c=this;c._events=c._events||{},a in c._events!=!1&&c._events[a].splice(c._events[a].indexOf(b),1)},k.prototype.emit=function(a){var b=this;if(b._events=b._events||{},a in b._events!=!1)for(var c=0;c<b._events[a].length;c++)b._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))};var l={};return l.messageTimeSort=function(a,b){return a.created>b.created},l.changeKey=function(a,b){a instanceof Array?a.forEach(function(a){a[e[b]]=a[b],delete a[b]}):(a[e[b]]=a[b],delete a[b])},h}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=a:"function"==typeof define&&define.amd?define([],function(){return a}):window.XPush=a}();